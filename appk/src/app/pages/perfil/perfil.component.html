<div class="perfil-container">
  <mat-tab-group animationDuration="0ms">
    <mat-tab label="Mi cuenta">
      <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()">
        <h2>Datos Fiscales</h2>
        <div class="datos-empresariales">
          <div class="fila">
            <mat-form-field class="campo" appearance="outline">
              <mat-label>Nombre o Razón social</mat-label>
              <input matInput formControlName="nombre">
              <mat-icon matPrefix>business</mat-icon>
              <mat-error *ngIf="perfilForm.get('nombre')?.hasError('required') && perfilForm.get('nombre')?.touched">
                Nombre es requerido
              </mat-error>
            </mat-form-field>
            
            <mat-form-field class="campo" appearance="outline">
              <mat-label>Nombre comercial</mat-label>
              <input matInput formControlName="nombreComercial">
              <mat-icon matPrefix>store</mat-icon>
            </mat-form-field>
          </div>
          
          <div class="fila">
            <mat-form-field class="campo" appearance="outline">
              <mat-label>Celular</mat-label>
              <input matInput formControlName="phone">
              <mat-icon matPrefix>phone</mat-icon>
              <mat-error *ngIf="perfilForm.get('phone')?.hasError('required') && perfilForm.get('phone')?.touched">
                Teléfono es requerido
              </mat-error>
              <mat-error *ngIf="perfilForm.get('phone')?.hasError('pattern') && perfilForm.get('phone')?.touched">
                Teléfono debe tener 10 dígitos
              </mat-error>
            </mat-form-field>
            
            <mat-form-field class="campo" appearance="outline">
              <mat-label>R.F.C.</mat-label>
              <input matInput formControlName="rfc">
              <mat-icon matPrefix>assignment_ind</mat-icon>
              <mat-error *ngIf="perfilForm.get('rfc')?.hasError('required') && perfilForm.get('rfc')?.touched">
                RFC es requerido
              </mat-error>
              <mat-error *ngIf="perfilForm.get('rfc')?.hasError('pattern') && perfilForm.get('rfc')?.touched">
                RFC no es válido
              </mat-error>
            </mat-form-field>
          </div>                
          
          <div class="fila">
            <mat-form-field class="campo" appearance="outline">
              <mat-label>Tipo de Persona</mat-label>
              <mat-select formControlName="tipoPersona">
                <mat-option value="fisica">
                  <mat-icon>person</mat-icon> Persona Física
                </mat-option>
                <mat-option value="moral">
                  <mat-icon>business</mat-icon> Persona Moral
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>badge</mat-icon>
              <mat-error *ngIf="perfilForm.get('tipoPersona')?.hasError('required') && perfilForm.get('tipoPersona')?.touched">
                Tipo de persona es requerido
              </mat-error>
            </mat-form-field>
          </div>
          <div class="fila">
            <mat-form-field class="campo campo-full" appearance="outline">
              <mat-label>Régimen Fiscal</mat-label>
              <mat-select formControlName="fiscalReg">
                <mat-option *ngFor="let regimen of regimenesFiscalesFiltrados" [value]="regimen.clave">
                  {{ regimen.clave }} - {{ regimen.descripcion }}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>receipt</mat-icon>
              <mat-error *ngIf="perfilForm.get('fiscalReg')?.hasError('required') && perfilForm.get('fiscalReg')?.touched">
                Régimen fiscal es requerido
              </mat-error>
              <mat-hint>Seleccione el régimen fiscal que le corresponde según el SAT</mat-hint>
            </mat-form-field>
          </div>
        
        </div>
        
        <div class="button-container">
          <button mat-raised-button color="primary" class="btn-primary" type="submit" [disabled]="perfilForm.invalid">
            <mat-icon>save</mat-icon> Guardar
          </button>
        </div>
      </form>    
    </mat-tab>

    <mat-tab label="Sucursales">
      <div class="sucursales-container">
        <h2>Configurar sucursales</h2>
        <div class="actions-row">
          <button mat-raised-button color="primary" class="btn-primary" (click)="openSucursalModal()">
            <mat-icon>add</mat-icon> Agregar
          </button>
        </div>
        
        <div class="table-container">
          <table mat-table class="mat-elevation-z8" [dataSource]="sucursales">
            <!-- Alias Column -->
            <ng-container matColumnDef="alias">
              <th mat-header-cell *matHeaderCellDef>Alias sucursal</th>
              <td mat-cell *matCellDef="let element">{{element.alias}}</td>
            </ng-container>

            <!-- Teléfono Column -->
            <ng-container matColumnDef="telefono">
              <th mat-header-cell *matHeaderCellDef>Teléfono</th>
              <td mat-cell *matCellDef="let element">{{element.telefono}}</td>
            </ng-container>

            <!-- Dirección Column -->
            <ng-container matColumnDef="direccion">
              <th mat-header-cell *matHeaderCellDef>Dirección</th>
              <td mat-cell *matCellDef="let element">{{element.direccion}}</td>
            </ng-container>

            <!-- Código Postal Column -->
            <ng-container matColumnDef="codigoPostal">
              <th mat-header-cell *matHeaderCellDef>Código postal</th>
              <td mat-cell *matCellDef="let element">{{element.codigoPostal}}</td>
            </ng-container>

            <!-- Colonia Column -->
            <ng-container matColumnDef="colonia">
              <th mat-header-cell *matHeaderCellDef>Colonia</th>
              <td mat-cell *matCellDef="let element">{{element.colonia}}</td>
            </ng-container>

            <!-- Acciones Column -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element">
                <button mat-icon-button color="warn" (click)="eliminarSucursal(element.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="displayedColumnsSucursales"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsSucursales;"></tr>
          </table>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Configuración factura">
      <div class="configuracion-factura">
        <!-- Nueva estructura con dos columnas -->
        <div class="factura-config-grid">
          <!-- Columna 1: Logo para comprobantes -->
          <section class="comprobante-logo">
            <h3>Logo para comprobantes</h3>
            <div class="logo-container">
              <img [src]="logoUrl || '/assets/img/no-logo.png'" alt="Logo en factura" class="preview-logo" (error)="onImageError($event)">
              <div class="logo-upload">
                <input type="file" id="logo-upload" hidden accept="image/png,image/jpeg,image/svg+xml" (change)="onLogoSelected($event)">
                <label for="logo-upload" class="file-upload-btn">
                  <mat-icon>upload_file</mat-icon> Seleccionar archivo
                </label>
                <span class="file-name">{{ logoFileName || 'Ningún archivo seleccionado' }}</span>
                <div *ngIf="logoFile" class="file-info">
                  <span>Tipo: {{ logoFile.type }}</span>
                  <span>Tamaño: {{ formatFileSize(logoFile.size) }}</span>
                </div>
              </div>
            </div>
            <mat-progress-bar *ngIf="uploading" mode="indeterminate"></mat-progress-bar>
            <div class="button-container">
              <button mat-raised-button color="primary" class="btn-primary section-button" 
                [disabled]="!logoFile || uploading" (click)="saveLogo()">
                <mat-icon>save</mat-icon> Guardar logo
              </button>
            </div>
          </section>

          <!-- Columna 2: Plantillas para facturas -->
          <section class="plantillas-factura">
            <h3>Plantillas para facturas</h3>
            <div class="plantillas-content">
              <p class="description">Selecciona el diseño de tus facturas electrónicas</p>
              <div class="plantilla-icon">
                <mat-icon class="large-icon">style</mat-icon>
              </div>
              <button mat-raised-button color="primary" class="btn-primary section-button" 
                (click)="navigateToInvoiceDesign()">
                <mat-icon>palette</mat-icon> Plantillas para facturas
              </button>
            </div>
          </section>
        </div>
        
        <section class="terminos-condiciones">
          <h3>Términos y condiciones para cotizaciones</h3>
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Términos y condiciones</mat-label>
            <textarea 
              matInput 
              [(ngModel)]="terminosCondiciones"
              rows="10"
              placeholder="Ingrese los términos y condiciones que aparecerán en sus cotizaciones...">
            </textarea>
            <mat-hint>Estos términos aparecerán al pie de todas sus cotizaciones</mat-hint>
          </mat-form-field>
  
          <div class="button-container">
            <button 
              mat-raised-button 
              color="primary" 
              class="btn-primary section-button"
              [disabled]="!terminosModificados"
              (click)="guardarTerminosCondiciones()">
              <mat-icon>save</mat-icon> Guardar términos
            </button>
          </div>
        </section>
        
        <section class="configurar-impuestos">
          <h3>Configurar impuestos</h3>
          <div class="table-container">
            <table mat-table [dataSource]="impuestos" class="mat-elevation-z8">
              <!-- Alias Column -->
              <ng-container matColumnDef="alias">
                <th mat-header-cell *matHeaderCellDef>Alias</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.alias}}</td>
              </ng-container>

              <!-- Uso Column -->
              <ng-container matColumnDef="uso">
                <th mat-header-cell *matHeaderCellDef>Uso</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.uso}}</td>
              </ng-container>

              <!-- Tipo Impuesto Column -->
              <ng-container matColumnDef="tipo_impuesto">
                <th mat-header-cell *matHeaderCellDef>Tipo de Impuesto</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.tipo_impuesto}}</td>
              </ng-container>

              <!-- Impuesto Column -->
              <ng-container matColumnDef="impuesto">
                <th mat-header-cell *matHeaderCellDef>Impuesto</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.impuesto}}</td>
              </ng-container>

              <!-- Tasa Column -->
              <ng-container matColumnDef="tasa">
                <th mat-header-cell *matHeaderCellDef>Tasa</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.tasa}}%</td>
              </ng-container>

              <!-- Valor Cuota Column -->
              <ng-container matColumnDef="valor_cuota">
                <th mat-header-cell *matHeaderCellDef>Factor</th>
                <td mat-cell *matCellDef="let impuesto">{{impuesto.valor_cuota}}</td>
              </ng-container>

              <!-- Acciones Column -->
              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let impuesto">
                  <button mat-icon-button color="warn" (click)="eliminarImpuesto(impuesto.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumnsImpuestos"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumnsImpuestos;"></tr>
            </table>
          </div>
          
          <div class="button-container">
            <button mat-raised-button color="primary" class="btn-primary section-button" (click)="openImpuestoModal()">
              <mat-icon>add</mat-icon> Agregar impuesto
            </button>
          </div>    
        </section>  
        
        <section class="cargar-archivos">
          <h3>Certificados</h3>
          <div class="archivos-container">
            <div class="csd-section">
              <h4>CSD para facturación</h4>
              <button mat-raised-button color="primary" class="btn-primary" (click)="openCsdUploadModal()">
                <mat-icon>upload_file</mat-icon> Cargar CSD
              </button>
              <p *ngIf="csdExpiryDate">
                Certificado válido hasta: <span class="expiry-date">{{ csdExpiryDate }}</span>
              </p>
              <p *ngIf="!csdExpiryDate" class="text-muted">
                No hay certificado CSD activo
              </p>
            </div>
            
            <div class="fiel-section">
              <h4>FIEL para descarga masiva</h4>
              <button mat-raised-button color="primary" class="btn-primary" (click)="openFielUploadModal()">
                <mat-icon>upload_file</mat-icon> Cargar FIEL
              </button>
              <p *ngIf="fielExpiryDate">
                Certificado válido hasta: <span class="expiry-date">{{ fielExpiryDate }}</span>
              </p>
              <p *ngIf="!fielExpiryDate" class="text-muted">
                No hay certificado FIEL activo
              </p>
            </div>
          </div>
        </section>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>